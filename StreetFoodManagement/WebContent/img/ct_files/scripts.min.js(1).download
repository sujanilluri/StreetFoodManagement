"use strict";function Cities(e){var s={},a={},n={},o={},r=0,c={};function u(t){var e=w(t);$("#countries").val(e).change()}function l(t){return"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),t.trim()}function i(t){t.preventDefault(),$("#statesContainer, #citiesContainer").hide(),$("#states, #cities").val(""),$(".placeholderText").html(""),d(0),C({action:"states",countryCode:w()},function(t){t&&"result"in t&&(n=t.result,function(){var t=Object.keys(n);{if(!t.length)return v("states",b()),h();if(1===t.length){var e=t[0],i=n[e];return $("#states").val(e).change().hide(),$("#statesPlaceholder").html('<span class="placeholderText">'+i+"</span>").show(),$("#statesContainer").show(),S()}}$("#statesPlaceholder").html("").hide(),$("#states").html(g(n)).show(),$("#statesContainer").show(),"state"in c&&function(t){var e=x(t);$("#states").val(e).change()}(c.state);S()}(),j())})}function f(t){t.preventDefault(),""==x()?($("#citiesContainer").hide(),$("#cities").val(""),d(0),S()):(h(),j())}function h(){C({action:"cities",countryCode:w(),stateCode:x()},function(t){if(t&&"result"in t)if(v("cities",(o=t.result)[0]),d(o.length||0),0===r)v("cities","No city on this state.");else if(1===r)v("cities",k());else if(20<=r){if($("#citiesPlaceholder").empty().hide(),$("#cities").is("select")){var e=$("<input />",{type:"text",id:"cities"}).val(i);$("#cities").replaceWith(e),y()}else if($("#cities").is("input")){var i="city"in c?c.city:"";$("#cities").val(i),y()}$("#cities, #citiesButton").show(),$("#citiesContainer").show(),S()}else $("#citiesPlaceholder").empty().hide(),m(o)})}function v(t,e){t="#"+t,$(t).val("").hide(),$(t+"Button").hide(),$(t+"Placeholder").text(e).show(),$(t+"Container").show(),S()}function d(t){"string"==typeof t&&(t=t.replace('"',""),parseInt(t).toString()!==t)||($("#citiesCount").html(0<t?"("+t+" cities)":""),r=t)}function p(t){if(t.preventDefault(),1e3<=r){var e="There are "+r+" cities in this state.";if(!confirm(e+=" Are you sure you want to show the whole list?"))return!1}var i=w();return i&&(0<Object.keys(o).length?m(o):C({action:"cities",countryCode:i,stateCode:x()},function(t){t&&"result"in t&&m(t.result)})),!1}function m(t){var e=$("<select>",{id:"cities",html:g(t)}).addClass("dropdowns");if("city"in c){var i=P(c.city);e.val(i)}$("#cities").replaceWith(e),$("#cities").on("change",j),$("#cities").focus(),$("#citiesButton").hide(),S()}function t(t,i){var n=w(),o=x(),r=t.term,e=function(t,e,i){return i=(i||"").toLowerCase(),!!(s[t]&&s[t][e]&&s[t][e][i])&&("object"==typeof s[t][e][i]&&s[t][e][i])}(n,o,r);e?i(e):C({action:"citiesAutocomplete",countryCode:n,stateCode:o,cityName:r},function(t){if(t&&"result"in t){var e=t.result;!function(t,e,i,n){i=(i||"").toLowerCase(),s[t]||(s[t]=[]);s[t][e]||(s[t][e]=[]);s[t][e][i]=n}(n,o,r,e),i(e)}})}function g(i){var t=Object.keys(i).sort(function(t,e){return i[t].toLowerCase()>i[e].toLowerCase()?1:-1}),e='<option value=""></option>';return t.forEach(function(t){e+='<option value="'+t+'" data-name="'+i[t]+'">'+i[t]+"</option>"}),e}function y(){$("#cities").autocomplete({minLength:2,source:t,open:S,close:S,change:function(){j(),S()}})}function C(t,e,i){$.ajax({url:"server.php",type:"POST",dataType:"json",data:t,error:function(){console.error("Error: failed to fetch data from server."),i&&i()},success:e})}function w(t){if(void 0!==t&&a){var e="";for(var i in a)if(a[i].shortname===t){e=a[i].id;break}return e}return $("#countries").val()}function b(){var t=w();return t?$("#countries option[value="+t+"]").text():""}function x(t){if(void 0!==t&&n){var e="";for(var i in n)if(n[i]===t){e=i;break}return e}return $("#states").val()}function k(){var t=$("#statesPlaceholder").text();if(t)return t;var e=x();return e?$('#states option[value="'+e+'"]').text():""}function P(t){if(void 0!==t&&o){var e="";for(var i in o)if(o[i]===t){e=i;break}return e}return $("#cities").val()}function W(){var t=$("#citiesPlaceholder").text();if(t)return t;var e=P();return $("#cities").is("select")?e?$('#cities option[value="'+e+'"]').text():"":$("#cities").is("input")?e:void 0}function j(){var t=W();JFCustomWidget.sendData({value:t||k()})}function S(){var t=$("body").height();$(".ui-autocomplete").is(":hidden")||(t+=$(".ui-autocomplete").outerHeight()),JFCustomWidget.requestFrameResize({height:t+10})}this.init=function(t){t&&t.value&&function(t){var e,i,n;if((t=t.split("\n")).forEach(function(t){t.match(/^Country: /)?e=l(t.replace(/Country: [^\(]+ \((.*)\)/,"$1")):t.match(/^State: /)?i=l(t.replace(/State: /,"")):t.match(/^City: /)&&(n=l(t.replace(/City: /,"")))}),!e)return;c={country:e,state:i,city:n}}(t.value);(function(e){C({action:"countries"},function(t){t&&"result"in t&&(a=t.result,e&&e(a))})})(function(){!JFCustomWidgetUtils.isEmpty(e.customCountries)&&e.customCountries?function(t){if(void 0!==t&&a){t=t.split(/\r\n|\r|\n/g);var e=[];for(var i in a){var n=a[i],o=!!~t.indexOf(n.shortname),r=!!~t.indexOf(n.name);if(o||r){if($("<option />",{value:n.id,"data-shortname":n.shortname}).text(n.name).appendTo($("#countries")),e.push(n),1===t.length){u(n.shortname);break}if(e.length===t.length){$("#countriesContainer").show(),"country"in c&&u(c.country);break}}}}}(e.customCountries):function(){if(a&&0<Object.keys(a).length){for(var t in a){var e=a[t];$("<option />",{value:e.id,"data-shortname":e.shortname}).text(e.name).appendTo($("#countries"))}$("#countriesContainer").show(),"country"in c&&u(c.country),S()}}()}),$("#countries").on("change",i),$("#states").on("change",f),$("#citiesButton").on("click",p)},this.getData=function(){var t=[];if(w()){var e=b(),i=function(){var t=w();return t?$("#countries option[value="+t+"]").attr("data-shortname"):""}();t.push("Country: "+e+" ("+i+")")}k()&&t.push("State: "+k());var n=W();n&&t.push("City: "+n);return 0==$("#states option:selected").text().length&&0==$("#statesPlaceholder").text().length?{valid:!1}:1<$("#cities > option").length?{valid:!!n,value:t.join("\n")}:$("#citiesContainer").is(":visible")&&0==$("#citiesPlaceholder").text().length&&$("#cities").is("input")&&0==$("#cities").val().length?{valid:!1}:{valid:!0,value:t.join("\n")}}}$(function(){JFCustomWidget.subscribe("ready",function(t){var e=new Cities(JFCustomWidget.getWidgetSettings());e.init(t),JFCustomWidget.subscribe("submit",function(){JFCustomWidget.sendSubmit(e.getData())})})});